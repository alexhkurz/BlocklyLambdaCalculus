<!DOCTYPE html>
<html>
<head>
    <title>A Blockly Lambda Calculus</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="custom_blocks.js"></script>
    <script src="defaultBlocks.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div>
        <a href="https://github.com/alexhkurz/BlocklyLambdaCalculus/tree/main/lc-with-definitions"target="_blank">
        <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"alt="GitHub Logo" width="20" height="20">
        View Source on GitHub
        </a>
    </div>
    <p>
        <details>
            <summary>Here for the first time?</summary>
            <p> The default BlocklyLambda program you see below defines the (anonymous) function "plus  one" (`x` is mapped to `x+1`) and applies it to the number `2`. </p>
            <p> "Generate JavaScript" compiles this to JavaScript (which is a programming language that     runs in your browser) and "Run JavaScript" executes it.</p>
            <p> You can remove the default program by dragging it out of the workspace. You can write your  own program by dragging blocks from the toolbox to the workspace. You can save your program to   a file and load it from a file. </p>
            <p> You can also save your program to a URL and load it from a URL. This is useful if you want  to share your program with others. </p>
        </details>
    </p>
    <div class="row">
        <div id="blocklyDiv" class="full-width"></div>
        <xml id="toolbox" style="display: none">
            <block type="functionDef"></block>
            <block type="functionCall"></block>
            <block type="abs"></block>
            <block type="app"></block>
            <block type="var"></block>
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </xml>
    </div>
    <div class="row button-row">
        <button onclick="generateCode()">Generate JavaScript</button>
        <button onclick="runCode()">Run JavaScript</button>
        <button onclick="saveBlocks()">Save Blocks to File</button>
        <button onclick="loadBlocks()">Load Blocks from File</button>
        <button onclick="saveBlocksToURL()">Save Blocks to URL</button>
        <button onclick="loadBlocksFromURL()">Load Blocks from URL</button>
        <input type="file" id="loadInput" style="display: none;" onchange="loadBlocksFile(event)">
    </div>
    <div class="row">
        <div id="codeDiv" class="half-width"></div>
        <div id="outputDiv" class="half-width"></div>
    </div>
    <script>
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            scrollbars: true
        });

        // Add event listener to workspace
        workspace.addChangeListener(saveBlocksToURL);

        // Load blocks from URL if present, else load default blocks
        loadBlocksFromURL();

        function generateCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            document.getElementById('codeDiv').innerText = code;
        }

        function runCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            try {
                var output = eval(code);
                document.getElementById('outputDiv').innerText = output;
            } catch (e) {
                document.getElementById('outputDiv').innerText = 'Error: ' + e;
            }
        }

        function saveBlocks() {
            var xml = Blockly.Xml.workspaceToDom(workspace);
            var xmlText = Blockly.Xml.domToPrettyText(xml);
            var blob = new Blob([xmlText], {type: 'text/xml'});
            var a = document.createElement('a');
            a.download = 'blocks.xml';
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        function loadBlocks() {
            document.getElementById('loadInput').click();
        }

        function loadBlocksFile(event) {
            var file = event.target.files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                var xml = Blockly.utils.xml.textToDom(e.target.result);
                Blockly.Xml.appendDomToWorkspace(xml, workspace);
            };
            reader.readAsText(file);
        }

        function saveBlocksToURL() {
            var xml = Blockly.Xml.workspaceToDom(workspace);
            var xmlText = Blockly.Xml.domToPrettyText(xml);
            try {
                var encodedXml = btoa(xmlText);
                var newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?blocks=' + encodedXml;
                window.history.pushState({path:newUrl},'',newUrl);
            } catch (e) {
                console.error('Error encoding blocks to URL:', e);
            }
        }

        function loadBlocksFromURL() {
            var urlParams = new URLSearchParams(window.location.search);
            var encodedXml = urlParams.get('blocks');
            if (encodedXml) {
                try {
                    var xmlText = atob(encodedXml);
                    var xml = Blockly.utils.xml.textToDom(xmlText);
                    Blockly.Xml.appendDomToWorkspace(xml, workspace);
                } catch (e) {
                    console.error('Error loading blocks from URL:', e);
                    loadDefaultBlocks();
                }
            } else {
                loadDefaultBlocks();
            }
        }

        function loadDefaultBlocks() {
            var defaultBlocksDom = Blockly.utils.xml.textToDom(defaultBlocks);
            Blockly.Xml.domToWorkspace(defaultBlocksDom, workspace);
        }

    </script>
</body>
</html>
